<!DOCTYPE html>
<html lang="en" style="background: transparent;">

<head>
  <meta charset="utf-8">
  <title>Dynamic Brochure Flipbook</title>
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="../../assets/images/favicon.svg">
  <!-- Flipbook StyleSheet -->
  <link href="components/css/dflip.min.css" rel="stylesheet" type="text/css">
  <!-- Icons Stylesheet -->
  <link href="components/css/themify-icons.min.css" rel="stylesheet" type="text/css">
  <style>
    html,
    body {
      background: transparent !important;
    }

    ._df_container,
    ._df_book,
    .df_container,
    #df_manual_book {
      background: transparent !important;
      background-color: transparent !important;
    }

    .container {
      background: transparent !important;
      background-color: transparent !important;
    }
    
    /* Disable flipbook loading animations */
    ._df_container,
    ._df_book,
    .df_container,
    #df_manual_book,
    ._df_container *,
    ._df_book *,
    .df_container *,
    #df_manual_book * {
      animation: none !important;
      transition: none !important;
    }
    
    /* Initially hide the flipbook to prevent animation */
    #df_manual_book {
      visibility: hidden;
    }
  </style>
</head>

<body style="background: transparent; margin: 0; padding: 0;">

  <div class="container" style="background: transparent;">
    <div class="" style="padding-bottom:30px; background: transparent;">
      <!--Dynamic FLipbook - PDF source will be set by JavaScript-->
      <div class="_df_book" height="1000" webgl="true" source="examples/example-assets/books/mainpage.pdf" id="df_manual_book"
        style="background: transparent !important;">
      </div>

    </div>
  </div>

  <!-- jQuery  -->
  <script src="components/js/libs/jquery.min.js" type="text/javascript"></script>
  <script>
    // Function to get PDF path from URL parameter (synchronous first, then async fallback)
    function getPDFPathFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const pdfParam = urlParams.get('pdf');
      if (pdfParam) {
        let pdfPath = decodeURIComponent(pdfParam);
        // Fix path - ensure it's relative to the flipbook folder
        pdfPath = pdfPath.replace(/\\/g, '/');
        
        // If path starts with /, remove it (absolute path from root)
        if (pdfPath.startsWith('/')) {
          pdfPath = pdfPath.substring(1);
        }
        
        // If path doesn't start with ../ or http, add ../ to go up from flipbook folder
        if (!pdfPath.startsWith('../') && !pdfPath.startsWith('http') && !pdfPath.startsWith('https')) {
          pdfPath = '../' + pdfPath;
        }
        
        console.log('Flipbook: PDF path from URL parameter:', pdfPath);
        return pdfPath;
      }
      return null;
    }
    
    // Function to get PDF path from CMS API (async)
    async function getPDFPathFromAPI() {
      try {
        const response = await fetch('../../api/get_content.php?page=index');
        if (response.ok) {
          const content = await response.json();
          if (content['brochure-pdf']) {
            const pdfData = content['brochure-pdf'];
            let pdfPath = pdfData.content;
            
            // Parse PDF path (format: "PDF:path")
            if (pdfPath && pdfPath.indexOf(':') !== -1) {
              const parts = pdfPath.split(':');
              pdfPath = parts.slice(1).join(':');
            }
            
            // Fix path - ensure it's relative to the flipbook folder
            if (pdfPath) {
              // Replace backslashes with forward slashes
              pdfPath = pdfPath.replace(/\\/g, '/');
              
              // If path starts with /, remove it (absolute path from root)
              if (pdfPath.startsWith('/')) {
                pdfPath = pdfPath.substring(1);
              }
              
              // If path doesn't start with ../ or http, add ../ to go up from flipbook folder
              if (!pdfPath.startsWith('../') && !pdfPath.startsWith('http') && !pdfPath.startsWith('https')) {
                pdfPath = '../' + pdfPath;
              }
              
              console.log('Flipbook: PDF path from CMS API:', pdfPath);
              return pdfPath;
            }
          }
        }
      } catch (error) {
        console.warn('Flipbook: Error loading PDF from API:', error);
      }
      return null;
    }
    
    // Set PDF source IMMEDIATELY (synchronously) before dflip loads
    // This ensures dflip reads the correct source when it initializes
    (function() {
      const flipbookElement = document.getElementById('df_manual_book');
      if (!flipbookElement) {
        console.error('Flipbook: Element not found!');
        return;
      }
      
      // Try to get PDF from URL parameter first (synchronous)
      let pdfPath = getPDFPathFromURL();
      
      if (pdfPath) {
        // Set source immediately from URL parameter
        flipbookElement.setAttribute('source', pdfPath);
        console.log('Flipbook: Source set from URL parameter to:', pdfPath);
      } else {
        // Keep default source, but try to update from API after page loads
        console.log('Flipbook: No URL parameter, using default source. Will try API...');
        // Note: API update will happen after dflip loads, which might not work
        // But at least we have a default PDF to show
      }
    })();
  </script>
  
  <!-- Flipbook main Js file -->
  <script src="components/js/dflip.min.js" type="text/javascript"></script>
  <script>
    // Wait for flipbook to load, then show it instantly
    $(document).ready(function() {
      console.log('Flipbook: Document ready, checking flipbook initialization');
      
      // Use jQuery to check if flipbook is initialized
      var checkFlipbook = setInterval(function() {
        var flipbook = $('#df_manual_book').find('._df_container');
        if (flipbook.length > 0) {
          console.log('Flipbook: Initialized successfully');
          clearInterval(checkFlipbook);
          document.getElementById('df_manual_book').style.visibility = 'visible';
          
          // Notify parent window that flipbook is loaded
          if (window.parent && window.parent !== window) {
            window.parent.postMessage('flipbookLoaded', '*');
            console.log('Flipbook: Sent flipbookLoaded message to parent');
          }
        }
      }, 100);
      
      // Timeout safety after 5 seconds
      setTimeout(function() {
        console.log('Flipbook: Timeout reached, showing flipbook anyway');
        clearInterval(checkFlipbook);
        document.getElementById('df_manual_book').style.visibility = 'visible';
        
        // Notify parent window that flipbook is loaded
        if (window.parent && window.parent !== window) {
          window.parent.postMessage('flipbookLoaded', '*');
          console.log('Flipbook: Sent flipbookLoaded message to parent (timeout)');
        }
      }, 5000);
    });
  </script>

</body>

</html>

